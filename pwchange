#!/usr/bin/env bash
# disable_and_reset_pw.sh
# Locks all users except root and splunk, and prompts once for a new password for whitelisted accounts.

set -euo pipefail
IFS=$'\n\t'

# ==========================
# CONFIGURATION
# ==========================
WHITELIST=("root" "splunk")
# ==========================

[ "$(id -u)" -eq 0 ] || { echo "ERROR: Must run as root"; exit 2; }

TS="$(date +%Y%m%d_%H%M%S)"
BKDIR="/root/account_backups_${TS}"
mkdir -p "$BKDIR"

echo "[+] Backing up account files to ${BKDIR}"
cp -p /etc/passwd   "${BKDIR}/passwd.${TS}"
cp -p /etc/shadow   "${BKDIR}/shadow.${TS}"
cp -p /etc/group    "${BKDIR}/group.${TS}"
cp -p /etc/gshadow  "${BKDIR}/gshadow.${TS}" 2>/dev/null || true
chmod 600 "${BKDIR}/shadow.${TS}" "${BKDIR}/gshadow.${TS}" 2>/dev/null || true

# Build whitelist regex
WL_RE="^($(printf '%s|' "${WHITELIST[@]}" | sed 's/|$//'))$"

echo "[+] Disabling all users except: ${WHITELIST[*]}"
while IFS=: read -r user _ uid gid _ home shell; do
  if [[ "$user" =~ $WL_RE ]]; then
    echo "  [keep] $user"
    continue
  fi

  echo "  [disable] $user"
  usermod -L "$user" 2>/dev/null || true     # lock account
  chage -E 0 "$user" 2>/dev/null || true     # expire immediately
  usermod -s /sbin/nologin "$user" 2>/dev/null || usermod -s /usr/sbin/nologin "$user" 2>/dev/null || true
done < /etc/passwd

# --------------------
# Prompt once for new password
# --------------------
echo
echo "[+] Enter new password to apply to all whitelisted accounts:"
read -rsp "New password: " NEW_PASS
echo
read -rsp "Confirm password: " CONFIRM_PASS
echo

if [[ "$NEW_PASS" != "$CONFIRM_PASS" ]]; then
  echo "ERROR: Passwords do not match. Aborting."
  exit 1
fi

# Apply to all whitelisted accounts
for user in "${WHITELIST[@]}"; do
  if id "$user" &>/dev/null; then
    echo "${user}:${NEW_PASS}" | chpasswd
    echo "  [updated] $user password changed"
  else
    echo "  [skip] $user not found"
  fi
done

echo
echo "[+] Done."
echo "    All non-whitelisted accounts locked and expired."
echo "    Root and Splunk passwords set to the password you entered."
echo "    Backups stored at: ${BKDIR}"
echo
echo "Quick verify:"
echo "  sudo passwd -S root splunk"
echo "  awk -F: '\$7 !~ /nologin|false/ {print \$1, \$7}' /etc/passwd"
